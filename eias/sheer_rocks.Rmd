---
title: "Sheer Rocks"
author: "Molly Wilson"
date: "2024-07-08"
output: html_document
---

```{r, message = F, warning = F, echo = F}
library(tidyverse)
library(here) 
library(readxl)
library(janitor)
library(knitr)
library(snakecase) # for adjusting capitalization of text within data (e.g., species names)

knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

## Seagrass

```{r}
sg_quadrants <- read_excel(here("eias", "sheer_rocks", "data_raw", "Sheer rocks_surveys.xlsx"), sheet = "seagrass quadrants") %>%  
  clean_names() %>%
  mutate(code = tolower(code))

sg_quad_exp <- sg_quadrants %>%
  expand(transect, quadrant, species) %>%
  left_join(quadrants %>% select(transect, quadrant, species, percent)) %>%
  mutate(percent = replace_na(percent, 0),
         orientation = case_when(str_detect(transect, "N") ~ "North",
                                 str_detect(transect, "S") ~ "South")) %>%
  left_join(quadrants %>% select(species, code, category), by ="species") %>%
  distinct()

test1 <- sg_quadrants %>%
  group_by(transect, quadrant) %>%
  summarize(total = sum(percent)) %>%
  filter(total != 100)

test2 <- sg_quad_exp %>%
  group_by(transect, quadrant) %>%
  summarize(total = sum(percent)) %>%
  filter(total != 100)

sg_cover_spp <- sg_quad_exp %>%
  group_by(transect, category, species) %>%
  summarise(percent_tran = mean(percent),
            se = sd(percent)/sqrt(10)) %>%
  group_by(category, species) %>%
  summarise(percent_tot = mean(percent_tran),
            se = sd(percent_tran)/sqrt(12)) %>%
  ungroup() %>%
  mutate(species = fct_reorder(species, desc(species)))
write.csv(sg_cover_spp, here("eias", "sheer_rocks", "data_outputs", "sg_cover_spp.csv"))

sg_cover_cat <- sg_quad_exp %>%
  group_by(transect, quadrant, category) %>%
  summarize(percent_cat = sum(percent)) %>%
  group_by(transect, category) %>%
  summarize(percent_tran = mean(percent_cat),
            se = sd(percent_cat)/sqrt(10)) %>%
  group_by(category) %>%
  summarize(percent_tot = mean(percent_tran),
            se = sd(percent_tran)/sqrt(12))
write.csv(sg_cover_cat, here("eias", "sheer_rocks", "data_outputs", "sg_cover_cat.csv"))
```

```{r}
ggplot(sg_cover_spp %>% 
         filter(category %in% c("Seagrass", "Algae")) %>%
         mutate(species = fct_reorder(species, percent_tot)), 
       aes(x = species, y = percent_tot, group = category, fill = category)) +
  geom_col(color = "black") +
  scale_fill_manual(values = c("orange3", "darkseagreen")) +
  coord_flip() +
  geom_errorbar(aes(ymin = percent_tot - se, ymax = percent_tot + se), width = .2) +
  labs(x = "", y = "Mean percent cover", fill = "Benthic category") +
  ylim(0,100) +
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"))
ggsave(here("eias", "sheer_rocks", "figs", "sg_cover_spp.png"), width = 6, height = 3)

ggplot(sg_cover_cat, aes(x = reorder(category, -percent_tot), y = percent_tot)) +
  geom_col(fill = "slategray3", color = "black") +
  geom_errorbar(aes(ymin = percent_tot - se, ymax = percent_tot + se), width = .2) +
  ylim(0, 100) +
  theme_bw() +
  labs(x = "Bategory", y = "Mean percent cover")
ggsave(here("eias", "sheer_rocks", "figs", "sg_cover_cat.png"), width = 6, height = 3)
```

## Reef benthic
```{r}
rf_benthic <- read_excel(here("eias", "sheer_rocks", "data_raw", "Sheer rocks_surveys.xlsx"), sheet = "benthic") %>%  
  clean_names() %>%
  select(transect, species_code, species, category, count) %>%
  group_by(transect, species_code, species, category) %>%
  summarise(count = sum(count)) %>%
  mutate(species = to_any_case(species, case = "sentence")) # this makes sure species names are correctly capitalized

rf_benthic_exp <- rf_benthic %>%
  expand(transect, species) %>%
  left_join(rf_benthic %>% select(transect, species, count), 
            by = c("transect", "species")) %>%
  mutate(count = replace_na(count, 0)) %>%
  left_join(quadrants %>% select(species, code, category), by ="species") %>%
  distinct()
```




