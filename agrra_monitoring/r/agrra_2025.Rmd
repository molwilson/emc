---
title: "Antigua AGRRA 2025"
author: "Molly Wilson"
date: "2025-08-01"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: cerulean
    highlight: haddock
---
# Setup

```{r setup}
# Install packages
library(tidyverse)
library(here) # for accessing files within directory
library(readxl) # for reading indv. sheets within excel files
library(janitor) # for cleaning variable names so they have consistent capitalization etc.

# Define settings
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# Define functions
se <- function(x) sd(x, na.rm = TRUE) / sqrt(sum(!is.na(x)))
```

# Benthic
    
Notes + questions:

- Appears no algal height data in 2017?
- 2017 coral species data - where to get from benthic surveys, not just coral surveys? Or were species not given then?
- How to access/integrate coral recruit data?

## Point cover

Data overview:

- 2017: "BenthicPointCoverScaledByTransect.xlsx" (scaled to not include non-reef substrate)
- 2025: "BenthicCoverScaledByTransect.xlsx"

### Import + wrangle data

```{r}
benthic_cover_2017 <- read_excel(here("agrra_monitoring", "data_raw", "ATG_NEMMA_2017", "BenthicPointCoverScaled", "BenthicPointCoverScaledByTransect.xlsx"), sheet = "Data") %>% 
  clean_names() %>%
  select(site, transect = trans, lc, cca, ta, tas, fma, cyan, ainv, pey = peys) %>%
  mutate(year = "2017",
         ta = ta + tas) %>% # to be compatible with 2025 data that aggregates TA and TAS into TA
  select(-tas)

benthic_cover_2025 <- read_excel(here("agrra_monitoring", "data_raw", "ATG_NEMMA_2025", "Calculated", "BenthicCoverScaledByTransect.xlsx"), sheet = "Overall") %>% 
  clean_names() %>%
  select(site = survey_name, transect = transect_name, t_coral, t_cca, t_ta, t_fma, t_cyan, t_ainv, t_pey) %>%
  mutate(across(contains("t_"), ~ . * 100)) %>%
  mutate(year = "2025",
         site = if_else(site == "Little Bird Patch", "Little Bird Backreef", site)) %>%
  rename_with(~ gsub("^t_", "", .x)) %>%
  rename(lc = coral)

benthic_cover_trans <- bind_rows(benthic_cover_2017, benthic_cover_2025) %>%
  filter(site != "Cades Reef Outside East") # currently excluding as we have no historical data

benthic_cover_site <- benthic_cover_trans %>%
  group_by(site, year) %>%
  summarise(across(c(lc, cca, ta, fma, cyan, ainv, pey),
                   list(mean = ~ mean(.x, na.rm = TRUE),
                        se   = ~ se(.x)),
                   .names = "{.col}_{.fn}"))

benthic_cover_year <- benthic_cover_site %>%
  select(!contains("_se")) %>%
  rename_with(~ str_remove(.x, "_mean")) %>%
  group_by(year) %>%
  summarise(across(c(lc, cca, ta, fma, cyan, ainv, pey),
                   list(mean = ~ mean(.x, na.rm = TRUE),
                        se   = ~ se(.x)),
                   .names = "{.col}_{.fn}"))
```

### Line plots

```{r}
ggplot(benthic_cover_site, aes(x = year, y = lc_mean, group = site, color = site)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Live Coral Cover (percent)", color = "Site", group = "Site") +
  theme_minimal()

ggplot(benthic_cover_site, aes(x = year, y = fma_mean, group = site, color = site)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "FMA Cover (percent)", color = "Site", group = "Site") +
  theme_minimal()
```

### Radar plots

Having issues adding the legend within an rmarkdown script, but red is 2017 and blue is 2025

```{r}
library(fmsb)

max_pc <- benthic_cover_year %>%
  select(contains("_mean")) %>%
  summarise(val = max(across(), na.rm = TRUE)) %>%
  pull(val)
ncol_pc <- ncol(benthic_cover_year %>%
  select(contains("_mean")))


benthic_rdr <- 
  rbind(rep(max_pc, ncol_pc), 
        rep(0, ncol_pc), 
        benthic_cover_year %>%
          column_to_rownames(var = "year") %>%
          select(contains("_mean")) %>%
          rename_with(~ gsub("_mean", "", .x))
        )
  
line_colors <- c("coral", "skyblue4")
fill_colors <- alpha(line_colors, 0.5)

radarchart(benthic_rdr,
           pcol = line_colors,
           pfcol = fill_colors,
           cglcol = "grey")

# doesn't like adding legend within rmarkdown - but can try within knit document
legend(
  x = "topright",
  legend = rownames(benthic_rdr)[3:4],  # skip max/min rows
  col = line_colors,
  lty = 1,
  lwd = 2,
  bty = "n",                   # no box
  cex = 0.8,
  pt.cex = 1.5,
  fill = fill_colors            # show fill colors in legend
)
```


### NMDS
```{r}
library(vegan)

benthic_nmds <- benthic_cover_site %>%
  select(!contains("_se")) %>%
  rename_with(~ gsub("_mean", "", .x))

# Separate metadata and community data
benthic_meta <- benthic_nmds %>% ungroup %>% select(site, year)
benthic_pc   <- benthic_nmds %>% ungroup %>% select(-site, -year)

# Run NMDS
set.seed(123) # fixes random number generator so results are reproducible
benthic_nmds_ord <- metaMDS(benthic_pc, distance = "bray", k = 2, trymax = 100)

# Extract NMDS scores and add metadata
site_scores <- scores(benthic_nmds_ord, display = "sites") %>%
  as.data.frame() %>%
  mutate(site = benthic_meta$site,
         year = benthic_meta$year)

# Extract pc (community variable) scores and add metadata
pc_scores <- scores(benthic_nmds_ord, display = "species") %>%
  as.data.frame() %>%
  rownames_to_column(var = "category")

# Plot NMDS

## defining NMDS arrows
arrow_mult <- 2
pc_scores_scaled <- pc_scores %>%
  mutate(NMDS1 = NMDS1 * arrow_mult,
         NMDS2 = NMDS2 * arrow_mult)

## adding offset columns to move arrow labels
pc_scores_scaled <- pc_scores_scaled %>%
  mutate(
    label_nudge_x = ifelse(NMDS1 >= 0, 0.05, -0.05),
    label_nudge_y = ifelse(NMDS2 >= 0, 0.05, -0.05)
  )

## plot
ggplot(site_scores, aes(x = NMDS1, y = NMDS2, color = year, shape = site)) +
  geom_point(size = 4) +
  stat_ellipse(aes(group = year), type = "t", linetype = 2) +
  geom_segment(data = pc_scores_scaled,
               aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.3, "cm")),
               color = "black",
               inherit.aes = FALSE) +
  geom_text(data = pc_scores_scaled,
            aes(x = NMDS1 + label_nudge_x,
                y = NMDS2 + label_nudge_y,
                label = category),
            color = "black",
            inherit.aes = FALSE) +
  
  theme_minimal()


  theme_minimal()



# PERMANOVA (adonis2)
set.seed(123)
adonis_res <- adonis2(benthic_pc ~ year, 
                      data = benthic_meta, 
                      method = "bray", 
                      permutations = 999)

print(adonis_res)

```

## Coral species composition

Data overview:

- 2017: "CoralCoverSpeciesScaledByTransect.xlsx" (is this from benthic or coral survey?)
- 2025: "BenthicCoralCoverScaledByTransect.xlsx" - gives percent cover by family, then within separate sheets per family it gives percent cover by species (inconvenient format... but could bind all sheets to get species-level data, or work with raw data)

### Import + wrangle data 
```{r}

```

# Fish

Data overview:

Notes + questions:

- To include commercially significant species, would have to go back to raw 2025 data or do custom calculations by family

## Biomass

Data overview:

- 2017: FishBiomassByTransect.xlsx
   - "Data" sheet has transect-level data by family and group
- 2025: FishBiomassByTransect.xlsx
   - "Overall" sheet has transect-level data by family
   - Family sheets have transect-level data by species

### Import + wrangle data

```{r}
fish_bm_2017 <- read_excel(here("agrra_monitoring", "data_raw", "ATG_NEMMA_2017", "FishBiomass", "FishBiomassByTransect.xlsx"), sheet = "Data") %>% 
  clean_names() %>%
  select(site, transect = trans, total = t, scar = parr, acan = surg) %>%
  mutate(year = "2017")

fish_bm_2025 <- read_excel(here("agrra_monitoring", "data_raw", "ATG_NEMMA_2025", "Calculated", "FishBiomassByTransect.xlsx"), sheet = "Overall") %>% 
  clean_names() %>%
  select(site = survey_name, transect = transect_name, total = all, scar = t_scar, acan = t_acan) %>%
  mutate(year = "2025",
         site = if_else(site == "Little Bird Patch", "Little Bird Backreef", site)) # inconsistency in site name between 2017 and 2025

fish_bm_trans <- bind_rows(fish_bm_2017, fish_bm_2025) %>%
  filter(site != "Cades Reef Outside East") # currently excluding as we have no historical data

fish_bm_site <- fish_bm_trans %>%
  group_by(site, year) %>%
  summarise(across(c(total, scar, acan),
                   list(mean = ~ mean(.x, na.rm = TRUE),
                        se   = ~ se(.x)),
                   .names = "{.col}_{.fn}"))
```

### Line plots

```{r}
ggplot(fish_bm_site, aes(x = year, y = total_mean, group = site, color = site)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Total fish biomass (g/100m2)", color = "Site", group = "Site") +
  theme_minimal()

ggplot(fish_bm_site, aes(x = year, y = scar_mean, group = site, color = site)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Scarid biomass (g/100m2)", color = "Site", group = "Site") +
  theme_minimal()

ggplot(fish_bm_site, aes(x = year, y = acan_mean, group = site, color = site)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Acanthurid biomass (g/100m2)", color = "Site", group = "Site") +
  theme_minimal()
```

## Length

Data overview: 

- 2017: FishSizeByTransect.xlsx (binned data only)
    - NF (number of fish) + raw numbers and % in each size bin
    - % is out of 100
    - Everything above 40cm gets aggregated
    - One sheet per family has transect-level size data
- 2025: FishSizeFreqByTransect.xlsx (binned data only)
    - NF (number of fish) + % in each size bin
    - % is out of one (proportion)
    - Over 40cm, bins are by 10cm to the nearest 10cm until <200cm
    - "Overall" sheet has transect-level size data
    - Family sheets have data by family

Notes + questions:

- Dealing with >40cm fish given aggregation into one group in 2017? Need to check raw data
- Correct to keep transects with no fish and include in mean size calculations?
- Does "SEAB" in 2017 refer to serranids?
- Weighted means: calculate midpoint representation of each size bin and weight by the number of counts per bin

### Import + wrangle data

```{r}
# starting with scarids only as mock-up
fish_length_2017 <- read_excel(here("agrra_monitoring", "data_raw", "ATG_NEMMA_2017", "FishSize", "FishSizeByTransect.xlsx"), sheet = "PARR") %>%
  clean_names() %>%
  select(site, transect = trans, nf, contains("percent_")) %>%
  mutate(across(
    .cols = contains("percent_"),
    .fns  = ~ .x / 100)) %>%
  rename_with(~ str_remove_all(.x, "percent_")) %>%
  rename("40_up" = "40") %>%
  mutate(year = "2017")

fish_length_2025 <- read_excel(here("agrra_monitoring", "data_raw", "ATG_NEMMA_2025", "Calculated", "FishSizeFreqByTransect.xlsx"), sheet = "tSCAR") %>%
  clean_names() %>%
  select(site = survey_name, transect = transect_name, nf, starts_with("x")) %>%
  rename_with(~ str_remove_all(.x, "^(x)|(cm$)")) %>%
  rowwise() %>% 
  mutate("40_up" = sum(c_across(matches("^\\d+$")), na.rm = TRUE)) %>% # select only columns with digits (e.g., 50, 60) and sum across these to be consistent with 2017 data, should not affect most of our fish families of interest
  ungroup() %>%
  select(!matches("^\\d+$")) %>%
  mutate(year = "2025",
         site = if_else(site == "Little Bird Patch", "Little Bird Backreef", site)) # inconsistency in site name between 2017 and 2025

fish_length_trans <- bind_rows(fish_length_2017, fish_length_2025) %>%
  filter(site != "Cades Reef Outside East") %>%
  select(-"40_up") # can't do anything with this atm because of 2017 aggregation - would need to check raw data

# check that all transects are present even if no fish per family were recorded
chk <- full_join(fish_length_trans %>%
                   group_by(year, site) %>%
                   summarize(count = n()), 
                 fish_bm_trans %>%
                   group_by(year, site) %>%
                   summarize(count = n()), 
                 by = c("year", "site"), suffix = c("_length", "_bm")) %>%
  filter(count_length != count_bm | is.na(count_length) | is.na(count_bm))
```

### Density plots
```{r}
# transform data for use in density plots
fish_long <- fish_length_trans %>%
  pivot_longer(
    cols = matches("^\\d+_?\\d?"), 
    names_to = "length_mid", 
    values_to = "percent"
  ) %>%
  mutate(
    # convert bin names like "0_5" -> 2.5
    length_mid = str_extract(length_mid, "\\d+_?\\d*"),
    length_mid = ifelse(str_detect(length_mid, "_"),
                        sapply(str_split(length_mid, "_"), function(x) mean(as.numeric(x))),
                        as.numeric(length_mid))) %>%
  group_by(year, site, transect) %>%
  mutate(prop = percent / sum(percent)) %>% # accounts for small deviations where total proportions don't equal exactly 1
  ungroup() %>%
  mutate(prop = replace_na(prop, 0)) # currently keeping transects with no fish
  
fish_length_site <- fish_long %>%
  group_by(year, site, length_mid) %>%
  summarise(mean_prop = mean(prop), .groups = "drop")

# Step 4: Average across sites to get one curve per year
fish_length_year <- fish_length_site %>%
  group_by(year, length_mid) %>%
  summarise(mean_prop = mean(mean_prop), .groups = "drop")

# Step 5: Plot density by year
ggplot(fish_length_year, aes(x = length_mid, weight = mean_prop, color = year, fill = year)) +
  geom_density(alpha = 0.3, adjust = 1) +
  labs(x = "Fish length (cm)", y = "Density") +
  theme_minimal()


```

# Archive {style="display:none;"}

```{r, eval = FALSE, include = FALSE}

# fish length data with raw numbers instead of percents in each bin
fish_length_trans <- bind_rows(fish_length_2017, fish_length_2025) %>%
  filter(site != "Cades Reef Outside East") %>%
  select(-"40_up") %>% # can't do anything with this atm because of 2017 aggregation - would need to check raw data
  rename_with( # renaming all size bin columns with midpoint value
    ~ {
      mids <- str_match(.x, "^(\\d+)_(\\d+)$") # select digit_digit columns
      ifelse(
        is.na(mids[,1]),
        .x,  # keep original name if it doesn't match pattern
        as.character((as.numeric(mids[,2]) + as.numeric(mids[,3])) / 2)
      )
    },
    .cols = everything()) %>%
  mutate(across(.cols = matches("^\\d+(\\.\\d+)?$"), # converting % to raw numbers
                  .fns  = ~ .x * nf / 100)) %>%
  mutate(across(where(is.numeric), ~ replace_na(.x, 0))) # replacing NA (percent of 0 when nf = 0) values

fish_length_site <- fish_length_trans %>%
  group_by(site, year) %>%
  summarise(across(matches("^\\d"),
                   list(mean = ~ mean(.x, na.rm = TRUE),
                        se   = ~ se(.x)),
                   .names = "{.col}_{.fn}"),
                   .groups = "drop")
```


