---
title: "MMA Mangroves"
author: "Molly Wilson"
date: "6/20/2022"
output: 
  html_document:
    code_folding: hide
---
# {.tabset}

```{r, message = F, warning = F, echo = F}
library(tidyverse)
library(here) 
library(readxl) 
library(janitor)
# library(stringr)

knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Invertebrates 

```{r}
# Import and clean data
mg_invert <- read_excel(here("mma", "data", "mma_mangroves.xlsx"), sheet = "inverts") %>%  
  clean_names() %>%
  unite(site_tran, site, transect, sep = "_", remove = FALSE) %>%
  mutate(type = str_to_title(type)) %>% # would prefer first cap, rest lower - maybe fix in data?
  filter(!is.na(site)) # remove any incomplete rows at the end of the data
```

## Mean abundance by type
* Need to consolidate into smaller number of "type"
```{r}
mg_invert_cat_site <- mg_invert %>%
  expand(nesting(site, transect), type) %>%
  left_join(mg_invert %>%
              select(site, transect, type, number)) %>%
  mutate(number = if_else(is.na(number), 0, number)) %>%
  group_by(site, transect, type) %>%
  summarize(abundance = sum(number)/30) %>% #indv./m2
  group_by(site, type) %>%
  summarize(abundance_mean = mean(abundance),
            abundance_se = sd(abundance)/sqrt(n()))

mg_invert_cat <- mg_invert_cat_site %>%
  group_by(type) %>%
  summarize(abundance = mean(abundance_mean),
            abundance_se = sd(abundance_mean)/sqrt(n())) %>%
  rename(abundance_mean = abundance)
  
ggplot(mg_invert_cat, aes(x = reorder(type, -abundance_mean), y = abundance_mean)) +
  geom_col(position = "dodge", fill = "seagreen") +
  geom_errorbar(aes(ymin = abundance_mean - abundance_se, ymax = abundance_mean + abundance_se), width = .2,
                 position = position_dodge(.9)) +
  labs(x = "", y = "Mean abundance (indv./m2)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(mg_invert_cat_site %>%
         filter(abundance_mean > 0), 
       aes(x = site, y = abundance_mean, fill = type)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = abundance_mean - abundance_se, ymax = abundance_mean + abundance_se), width = .2,
                 position = position_dodge(.9)) +
  labs(x = "Site", y = "Mean abundance (indv./m2)") +
  theme_bw()
```

## Mean abundance by species
```{r}
mg_invert_spp <- mg_invert %>%
  expand(nesting(site, transect), species) %>%
  left_join(mg_invert %>%
              select(site, transect, species, number)) %>%
  mutate(number = if_else(is.na(number), 0, number)) %>%
  group_by(site, transect, species) %>%
  summarize(abundance = sum(number)/30) %>% #indv./m2
  group_by(site, species) %>%
  summarize(abundance_mean = mean(abundance),
            abundance_se = sd(abundance)/sqrt(n())) %>%
  group_by(species) %>%
  summarize(abundance = mean(abundance_mean),
            abundance_se = sd(abundance_mean)/sqrt(n())) %>%
  rename(abundance_mean = abundance)

ggplot(mg_invert_spp, aes(x = reorder(species, abundance_mean), y = abundance_mean)) +
  geom_col(position = "dodge", fill = "seagreen") +
  geom_errorbar(aes(ymin = abundance_mean - abundance_se, ymax = abundance_mean + abundance_se), width = .2,
                 position = position_dodge(.9)) +
  coord_flip() +
  labs(x = "", y = "Mean abundance (indv./m2)") +
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"))
```

# Fish
```{r}
# Import and clean data

mg_fish <- read_excel(here("mma", "data", "mma_mangroves.xlsx"), sheet = "fish") %>%  
  clean_names() %>%
  filter(!is.na(site)) %>% # remove any incomplete rows at the end of the data
  # unite(site_tran, site, transect, sep = "_", remove = FALSE) %>%
  mutate(number = if_else(is.na(number), 1, number)) %>% # all entries with no number specified were single observations
  uncount(number) %>% # expand to replicate rows if multiple fish were recorded to look at length distributions
  mutate(biomass = as.numeric(biomass),
         phase_code = tolower(phase),
         phase = case_when(phase == "j" ~ "Juvenile",
                           phase == "i" ~ "Initial",
                           phase == "t" ~ "Terminal"),
         family_c = if_else(family %in% c("Atherinidae", "Clupeidae", "Scaridae", "Haemulidae", "Lutjanidae", "Sphyraenidae"), family, "Other")) # consolidating the number of families
```

## Mean total biomass by site
```{r}
# calculating total biomass in each transect (sum) -> mean at each site
mg_fish_site <- mg_fish %>% 
  group_by(site, transect) %>%
  summarize(biomass_tot = sum(biomass)/1000/120*10000) %>% #kg/ha
  group_by(site) %>%
  summarize(biomass_mean = mean(biomass_tot),
            biomass_se = sd(biomass_tot)/sqrt(n()))

ggplot(mg_fish_site, aes(x = site, y = biomass_mean)) +
  geom_col(fill = "lightblue", alpha = 0.8) +
  geom_errorbar(aes(ymin = biomass_mean - biomass_se, ymax = biomass_mean + biomass_se), width = .2,
                 position = position_dodge(.9)) +
  labs(x = "Site", y = "Biomass (kg/ha)") +
  theme_bw()
```


## Mean biomass and fish length by family and site
```{r}
# calculating total biomass and mean length per family at each transect -> mean at each site
mg_fish_fam_site <- mg_fish %>% 
  expand(nesting(site, transect), family_c) %>%
  left_join(mg_fish %>%
      select(site, transect, family_c, length, biomass)) %>%
  mutate(biomass = if_else(is.na(biomass), 0, biomass),
         length = if_else(is.na(length), 0, length)) %>%
  distinct() %>%
  group_by(site, transect, family_c) %>%
  summarize(biomass_tot = sum(biomass)/1000/120*10000, #kg/ha
            length = mean(length)) %>%
  group_by(site, family_c) %>%
  summarize(biomass_mean = mean(biomass_tot),
            biomass_se = sd(biomass_tot)/sqrt(n()),
            length_mean = mean(length),
            length_se = sd(length)/sqrt(n()))

mg_fish_fam <- mg_fish_fam_site %>%
  group_by(family_c) %>%
  summarize(biomass = mean(biomass_mean),
            biomass_se = sd(biomass_mean)/sqrt(n()),
            length = mean(length_mean),
            length_se = sd(length_mean)/sqrt(n())) %>%
  rename(biomass_mean = biomass,
         length_mean = length) %>%
  mutate(site = "Mean across sites") %>%
  rbind(mg_fish_family_site) 

# testing accuracy of site-level calculations
test1 <- sg_quads %>% filter(site == "Garden of Eden"  & species == "Penicillus spp.")
test2 <- sg_spp %>% filter(site == "Garden of Eden" & species == "Penicillus spp.")
test3 <- sg_spp %>%
  group_by(site, transect, species, category) %>%
  summarize(pc_t = mean(percent)) %>%
  filter(site == "Garden of Eden" & species == "Penicillus spp.")
test4 <- pc_spp_site %>% filter(site == "Garden of Eden" & species == "Penicillus spp.")
  
ggplot(mg_fish_family %>% 
         filter(biomass_mean >0 & site == "Mean across sites"), 
       aes(x = reorder(family_c, -biomass_mean), y = biomass_mean)) +
  geom_col(position = "dodge", fill = "slategray4", alpha = 0.9) +
  geom_errorbar(aes(ymin = biomass_mean - biomass_se, ymax = biomass_mean + biomass_se), width = .2,
                 position = position_dodge(.9)) +
  labs(x = "Family", y = "Biomass (kg/ha)") +
  theme_bw()

ggplot(mg_fish_family %>% 
         filter(biomass_mean >0 & site != "Mean across sites"), 
       aes(x = site, y = biomass_mean, fill = family_c)) +
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = biomass_mean - biomass_se, ymax = biomass_mean + biomass_se), width = .2,
                 position = position_dodge(.9)) +
  labs(x = "Family", y = "Biomass (kg/ha)", fill = "Family") +
  theme_bw()
```

## Mean biomass and fish length by species
```{r}
mg_fish_spp_site <- mg_fish %>%
  expand(nesting(site, transect), species_code) %>%
  left_join(mg_fish %>%
      select(site, transect, species_code, length, biomass)) %>%
  left_join(mg_fish %>%
              select(species_code, species_name, common_name) %>%
              distinct(), 
            by = "species_code") %>%
  mutate(biomass = if_else(is.na(biomass), 0, biomass),
         length = if_else(is.na(length), 0, length)) %>%
  group_by(site, transect, species_code, species_name, common_name) %>%
  summarize(biomass_tot = sum(biomass)/1000/120*10000, #kg/ha
            length = mean(length)) %>%
  group_by(site, species_code, species_name, common_name) %>%
  summarize(biomass_mean = mean(biomass_tot),
            biomass_se = sd(biomass_tot)/sqrt(n()),
            length_mean = mean(length),
            length_se = sd(length)/sqrt(n()))

mg_fish_spp <- mg_fish_spp_site %>%
  group_by(species_code, species_name, common_name) %>%
  summarize(biomass = mean(biomass_mean),
            biomass_se = sd(biomass_mean)/sqrt(n()),
            length = mean(length_mean),
            length_se = sd(length_mean)/sqrt(n())) %>%
  rename(biomass_mean = biomass,
         length_mean = length)

ggplot(mg_fish_spp, aes(x = reorder(species_name, biomass_mean), y = biomass_mean)) +
  geom_col(color = "black", fill = "lightblue2", alpha = 0.8, stat = "identity",
           position = position_dodge()) +
  geom_errorbar(aes(ymin = biomass_mean - biomass_se, ymax = biomass_mean + biomass_se), width = .2,
                 position = position_dodge(.9)) +
  coord_flip() +
  labs(x = "", y = "Mean biomass (kg/ha)") +
  theme_bw() +
  theme(axis.text.y = element_text(face = "italic"))
```

## Distribution of fish lengths (or relative abundance of juveniles?)
* Issue here is that we have more transects for some sites than others... is there a way to scale them?
* Need to add common names for families
```{r}
ggplot(mg_fish, aes(x = site, y = length)) +
  geom_violin() +
  theme_bw()

# Density plots of lengths by family across all sites/transects?
ggplot(mg_fish %>% 
         filter(family %in% c("Acanthuridae", "Scaridae", "Haemulidae", "Lutjanidae")),
       aes(x = length, fill = family)) +
  geom_density(alpha = 0.4) +
  facet_grid(rows = vars(family)) +
  labs(y = "Abundance", x = "Fish length (cm)", fill = "Family") +
  theme_bw()
## need to add common names for families
## don't really need fill colors by family...
```

