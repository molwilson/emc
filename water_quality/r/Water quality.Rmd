---
title: "Water quality testing"
author: "Molly Wilson"
date: "2024-05-10"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here) # for accessing files with directory
library(readxl) # for reading indv. sheets within excel files
library(janitor) # for cleaning variable names so they have consistent capitalization etc.
library(lubridate) # for converting date formats
library(zoo) # for converting date formats
library(knitr) # for including tables
library(ggpubr) # for printing multiple plots together

knitr::opts_chunk$set(message = FALSE, warning = FALSE) # this sets the preferences for each code chunk so that errors/messages/warnings don't get displayed in the knit rmarkdown
```

```{r}

sites <- read_excel(here("water_quality", "data_raw", "Water quality data.xlsx"), sheet = "sites") %>% 
  clean_names()
precip <- read_excel(here("water_quality", "data_raw", "Water quality data.xlsx"), sheet = "precipitation") %>% 
  clean_names()
entero <- read_excel(here("water_quality", "data_raw", "Water quality data.xlsx"), sheet = "enterococcus") %>% 
  clean_names()
ysi <- read_excel(here("water_quality", "data_raw", "Water quality data.xlsx"), sheet = "ysi") %>% 
  rename_with(tolower) %>% # prevents clean_names() from adding extra underscores before caps
  clean_names() %>%
  rename(site_code_depth = site_code) %>%
  filter(as.character(date) != "2023-10-05") # incomplete/aborted day

wq_data <- ysi %>%
  select(date, site_code_depth, temperature_c = temperature_c_24, ph, do_mg_l, do_percent_sat, conductivity_us_cm, sal_psu, phycoerythrin_rfu, chlorophyll_rfu) %>%
  drop_na() %>%
  left_join(ysi %>%
              select(date, site_code_depth, turbidity_fnu) %>%
              drop_na(),
            by = c("date", "site_code_depth")) %>%
  mutate(site_code = str_replace(site_code_depth, "[:digit:]", ""),
         depth_m = parse_number(site_code_depth),
         depth_m = replace_na(depth_m, 1)) %>% # surface-only sites are assumed to be approx 1m
           # str_sub(site_code_depth, start = -1L, end = -1L)) %>%
  left_join(sites, by = c("site_code")) %>%
  left_join(entero, by = c("date", "site_code")) %>%
  mutate(n_colonies = replace_na(n_colonies, 0),
         date = as.character(date),
         month = month(ymd(date), label = TRUE),
         year = year(ymd(date)),
         date_label = paste(as.character(month), as.character(year)),
         date_cat = if_else(month %in% c("Dec", "Jan", "Feb", "Mar", "Apr", "May"), "High season", "Low season"),
         site_cat = if_else(site_code %in% c("YIE", "GIE"), "Control", "Treatment")
         ) %>%
  select(date, date_label, date_cat, site_code_depth, site_code, depth_m, site_name, site_cat, temperature_c, ph, do_mg_l, do_percent_sat, conductivity_us_cm, sal_psu, phycoerythrin_rfu, chlorophyll_rfu, turbidity_fnu, n_colonies) 

```
Need to create metrics for precipitation
- amount of rain in 24hrs / 48 hrs prior
- ratio of rain 1 week prior vs. month prior?
```{r}

```


```{r}
# Target ranges
rect_dat_ph = data.frame(xmin = -Inf, xmax = Inf, ymin = 7.7, ymax = 8.5) # 7.5 and 8.4 units  (Rogers et al., 2001)
rect_dat_sal = data.frame(xmin = -Inf, xmax = Inf, ymin = 32, ymax = 42) # 32,000 to 42,000 ppm (NOAA)
rect_dat_turb = data.frame(xmin = -Inf, xmax = Inf, ymin = 0, ymax = 2) # <2 NTU (EPA)
rect_dat_do = data.frame(xmin = -Inf, xmax = Inf, ymin = 6, ymax = Inf) # Must be greater than 6.0 ppm  (EPMA, 2019)
rect_dat_temp = data.frame(xmin = -Inf, xmax = Inf, ymin = 23, ymax = 29.6) # 23°–29°Celsius (Coral Reef Alliance)
line_dat_temp_bleaching = 30.63 # 30.63C bleaching threshold (NOAA)
rect_dat_ent = data.frame(xmin = -Inf, xmax = Inf, ymin = 0, ymax = 7) # below 7/100mL (EPA)

c_range <- "slategray1" # setting color for target range in graphs
  
# shapes_dates <- c(16, 1, 2)
# colors_dates <- c("blue", "black", "black", "black")
# alphas_dates <- c(1, 0.3, 0.3, 0.3)
theme <- theme_bw() +
  theme(axis.text.x = element_text(angle = 45, h = 1),
        legend.text = element_text(size = 9), 
        legend.title = element_text(size = 10))
```

Plot wish list:

- first understand differences at depth? (or look at only 1m depths for now?)
- x = site, y = metric, color = date
- plot results on a map???
- x = time, y = metric, multiple lines per site

```{r}
# creating list of regularly monitored sites (keep GEB?) 
# still need to clean a few site names etc. (e.g., sites from Amy's visits), but omitting those here
# should we remove boom sites to have less going on in exchange bay, or combine/compile?
# almost want to separate sites relevant to MRC/human impacts, and sites relevant to restoration to keep things streamlined
sites_monitoring <- c("NBRB", "NBRM", "EC", "NBA", "LBI", "GIA", "ML", "RBA", "RRS", "GOE", "TPBN", "GIE", "YIE", "DB", "MRCH", "EBBW", "COV", "GEB", "EBB", "FHB", "YIN", "YRS", "BDB", "LDB", "MRYC")

# color dates by season?
# classify control sites?

ggplot() +
  geom_rect(data = rect_dat_ph, 
              aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = "What"),
              alpha = 0.4) +
  scale_fill_manual(values = c_range, guide = "none") +
  geom_point(data = filter(wq_data, 
                           site_code %in% c(sites_monitoring) & depth_m == 1), 
             aes(x = site_name, y = ph)) +
  labs(x = "", y = "pH") +
  ylim(7.5, 9) +
  theme +
  coord_flip()

# flipped point plot play
ggplot() +
  geom_point(data = filter(wq_data, 
                           site_code %in% c(sites_monitoring)), 
             aes(x = site_name, y = chlorophyll_rfu, color = date_cat)) +
  labs(x = "", y = "Chlorophyll a") +
  theme +
  coord_flip()

ggplot() +
  geom_point(data = filter(wq_data, 
                           site_code %in% c(sites_monitoring)), 
             aes(x = site_name, y = n_colonies, color = date_cat),
             alpha = 0.3) +
  labs(x = "", y = "Enterococcus colonies") +
  theme +
  coord_flip()

# line plot play
ggplot() +
  geom_line(data = filter(wq_data, 
                           site_code %in% c(sites_monitoring) & depth_m == 1), 
             aes(x = date, y = ph, group = site_name, color = site_cat)) +
  labs(x = "", y = "ph") +
  theme

```

