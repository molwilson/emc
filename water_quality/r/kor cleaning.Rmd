---
title: "Kor Cleaning"
author: "Molly Wilson"
date: "2026-01-16"
output: html_document
---

```{r, message = F, warning = F, echo = F}
library(tidyverse)
library(here) 
library(readxl) 
library(janitor)
library(scales)
library(lubridate)

knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(here)

raw <- read_csv(here("water_quality", "data_raw",
  "Kor Measurement File Export.csv"), 
  # skip = 4, #  for OG file?
  col_names = FALSE,
  show_col_types = FALSE) %>%
  filter(!str_detect(X1, "MEAN VALUE|STANDARD DEVIATION|SENSOR SERIAL NUMBER")) # extraneous rows

# Identify header rows for each sensor type
header_turbidity <- "TURBIDITY FNU"
header_gen <- "TAL PE RFU"
```


```{r}
library(tidyverse)
library(janitor)

# Read CSV (skip any extraneous rows if needed)
raw <- read_csv(here("water_quality", "data_raw", "Kor Measurement File Export.csv"),
                col_names = FALSE, show_col_types = FALSE) %>%
  filter(!str_detect(X1, "MEAN VALUE|STANDARD DEVIATION|SENSOR SERIAL NUMBER"))

# Define sensor header identifiers
header_turbidity <- "TURBIDITY FNU"
header_gen       <- "TAL PE RFU"

# Detect header rows by scanning each row
header_rows_turbidity <- which(apply(raw, 1, function(row) any(str_detect(as.character(row), header_turbidity))))
header_rows_gen       <- which(apply(raw, 1, function(row) any(str_detect(as.character(row), header_gen))))

# Rows immediately below headers are the data rows
data_rows_turbidity <- header_rows_turbidity + 1
data_rows_gen       <- header_rows_gen + 1

# Function to clean each sensor type
clean_sensor <- function(header_rows, data_rows, raw_df) {
  blocks <- map2(header_rows, data_rows, ~{
    header <- as.character(unlist(raw_df[.x, ]))
    header[is.na(header) | header == ""] <- paste0("empty_col_", seq_len(sum(is.na(header) | header == "")))
    header <- make.names(header, unique = TRUE)
    
    data <- as.character(unlist(raw_df[.y, ]))
    df <- as_tibble(as.list(data), .name_repair = "minimal")
    colnames(df) <- make_clean_names(header)
    df
  })
  
  tidy_df <- bind_rows(blocks) %>%
    mutate(across(everything(), ~ type.convert(., as.is = TRUE)))
  
  if(all(c("date", "time") %in% names(tidy_df))){
    tidy_df <- tidy_df %>%
      mutate(
        date = as.Date(date, format = "%m/%d/%Y"),
        datetime = as.POSIXct(paste(date, time), format = "%Y-%m-%d %H:%M:%S")
      )
  }
  
  tidy_df
}

# Clean each sensor separately
turbidity_df <- clean_sensor(header_rows_turbidity, data_rows_turbidity, raw)
general_df   <- clean_sensor(header_rows_gen, data_rows_gen, raw)

# Optional: merge both sensor types by datetime + site
master_df <- full_join(turbidity_df, general_df, by = c("datetime", "site_name"))

# âœ… Results
turbidity_df
general_df
master_df

```

