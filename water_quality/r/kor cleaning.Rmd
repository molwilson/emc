---
title: "Kor Cleaning"
author: "Molly Wilson"
date: "2026-01-16"
output: html_document
---

```{r, message = F, warning = F, echo = F}
library(tidyverse)
library(here) 
library(readxl) 
library(janitor)
library(scales)
library(lubridate)

knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
# import raw YSI data from Kor .csv export
raw <- read_csv(here("water_quality", "data_raw", "Kor Measurement File Export.csv"),
  col_names = FALSE,
  show_col_types = FALSE) %>%
  filter(!str_detect(X1, "MEAN VALUE|STANDARD DEVIATION|SENSOR SERIAL NUMBER"))

# import list of entries to be omitted
omissions <- read_excel(here("water_quality", "data_raw", "Water quality data.xlsx"), sheet = "ysi report omissions")
### need to reformat date/times

# import list of entries to be corrected
```

Cleaning YSI/Kor .csv
```{r}
# identify header rows for each sensor type
header_rows_turbidity <- which(apply(raw, 1, function(row)
  any(str_detect(as.character(row), "TURBIDITY FNU"))
))

header_rows_gen <- which(apply(raw, 1, function(row)
  any(str_detect(as.character(row), "TAL PE RFU"))
))

# identify data rows for each sensor type
data_rows_turbidity <- header_rows_turbidity + 1
data_rows_gen       <- header_rows_gen + 1

# function for cleaning data into one tibble per sensor
clean_sensor <- function(header_rows, data_rows, raw_df) {

  blocks <- map2(header_rows, data_rows, ~{

    header <- as.character(unlist(raw_df[.x, ]))
    header <- iconv(header, from = "", to = "UTF-8", sub = "")

    empty_idx <- which(is.na(header) | header == "")
    header[empty_idx] <- paste0("empty_col_", seq_along(empty_idx))

    header <- make.names(header, unique = TRUE)
    header <- make_clean_names(header)

    data <- as.character(unlist(raw_df[.y, ]))

    df <- as_tibble(as.list(data), .name_repair = "minimal")
    colnames(df) <- header

    df
  })

  tidy_df <- bind_rows(blocks) %>%
    mutate(across(everything(), ~ type.convert(., as.is = TRUE)))

  # if (all(c("date_m_d_yyyy", "time_h_mm_ss_tt") %in% names(tidy_df))) {
  #   tidy_df <- tidy_df %>%
  #     mutate(
  #       datetime = as.POSIXct(
  #         paste(date_m_d_yyyy, time_h_mm_ss_tt),
  #         format = "%m/%d/%Y %I:%M:%S %p",
  #         tz = "UTC"
  #       ),
  #       date = as.Date(datetime)
  #     )
  #}

  tidy_df
}

turbidity_df <- clean_sensor(header_rows_turbidity, data_rows_turbidity, raw) %>%
  select(date_m_d_yyyy, time_h_mm_ss_tt, site_name, turbidity_fnu)

general_df <- clean_sensor(header_rows_gen, data_rows_gen, raw) %>%
  select(date_m_d_yyyy, time_h_mm_ss_tt, site_name, tal_pe_rfu, chlorophyll_rfu, cond_s_cm, spcond_s_cm, tds_mg_l, sal_psu, odo_mg_l, ph, temp_c)

```



